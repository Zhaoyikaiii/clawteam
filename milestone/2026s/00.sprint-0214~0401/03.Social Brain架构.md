# ClawTeam - Social Brain æ¶æ„è¯¦è§£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2026-02-14
> **æ ¸å¿ƒå®šä½**: äº‹ä»¶é©±åŠ¨çš„æ™ºèƒ½ç¼–æ’ä¸­æ¢

## ğŸ“‹ ç›®å½•

- [1. æ¶æ„æ¦‚è¿°](#1-æ¶æ„æ¦‚è¿°)
- [2. æ¨¡å—è¯¦è§£](#2-æ¨¡å—è¯¦è§£)
- [3. æ ¸å¿ƒæ¥å£](#3-æ ¸å¿ƒæ¥å£)
- [4. å†³ç­–æµç¨‹](#4-å†³ç­–æµç¨‹)
- [5. å¼‚å¸¸å¤„ç†](#5-å¼‚å¸¸å¤„ç†)

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 Social Brain å®šä½

Social Brain æ˜¯ ClawTeam çš„ **"æ™ºèƒ½è°ƒåº¦ä¸­æ¢"**ï¼Œè´Ÿè´£ï¼š

1. **ç†è§£**å½“å‰èŠå¤©çš„ä¸Šä¸‹æ–‡å’Œæ„å›¾
2. **å†³ç­–**æ˜¯å¦è§¦å‘ Agentï¼Œè§¦å‘å“ªäº› Agent
3. **ç¼–æ’**å¤š Agent åä½œä»»åŠ¡
4. **æ§åˆ¶**æƒé™è¾¹ç•Œå’Œå®‰å…¨ç­–ç•¥
5. **æ•´åˆ**å¤šä¸ª Agent çš„ç»“æœ
6. **è®°å¿†**å†³ç­–è¿‡ç¨‹å’Œç»“æœ

### 1.2 æ¨¡å—æ¶æ„å›¾

```mermaid
flowchart TB
    %% Input
    subgraph Input["è¾“å…¥å±‚"]
        Event["Message Event\næ¶ˆæ¯äº‹ä»¶"]
        Approval["Approval Event\nå®¡æ‰¹äº‹ä»¶"]
        Callback["Callback Event\nå›è°ƒäº‹ä»¶"]
    end

    %% Context Building
    subgraph Ctx["ä¸Šä¸‹æ–‡æ„å»º"]
        CtxBldr["Context Builder\nä¸Šä¸‹æ–‡æ„å»ºå™¨"]
        Recent["Recent Messages\næœ€è¿‘æ¶ˆæ¯"]
        Thread["Thread Context\nçº¿ç¨‹ä¸Šä¸‹æ–‡"]
        ChatInfo["Chat Info\nç¾¤ä¿¡æ¯"]
        Participants["Participants\nå‚ä¸è€…"]
    end

    %% Intent & Trigger
    subgraph IT["æ„å›¾ä¸è§¦å‘"]
        Intent["Intent Classifier\næ„å›¾åˆ†ç±»"]
        Trigger["Trigger Detector\nè§¦å‘æ£€æµ‹"]
        Explicit["@ Detection\n@æ£€æµ‹"]
        Implicit["Implicit Intent\néšå¼æ„å›¾"]
    end

    %% Recall & Rank
    subgraph RR["å¬å›ä¸æ’åº"]
        CapIndex["Capability Index\nèƒ½åŠ›ç´¢å¼•"]
        Recall["Agent Recall\nAgentå¬å›"]
        Ranker["Agent Ranker\nAgentæ’åº"]
        Scores["Score:\n- èƒ½åŠ›åŒ¹é…\n- å†å²è¡¨ç°\n- æˆæœ¬ä¼°ç®—\n- é£é™©è¯„åˆ†"]
    end

    %% Policy
    subgraph Policy["ç­–ç•¥ä¸æƒé™"]
        PDP["Policy Decision Point\nç­–ç•¥å†³ç­–ç‚¹"]
        RBAC["RBAC\nè§’è‰²è®¿é—®æ§åˆ¶"]
        ABAC["ABAC\nå±æ€§è®¿é—®æ§åˆ¶"]
        Scopes["Scope Check\nä½œç”¨åŸŸæ£€æŸ¥"]
    end

    %% Planning
    subgraph Plan["è§„åˆ’ä¸è°ƒåº¦"]
        Planner["Planner\nè§„åˆ’å™¨"]
        Decompose["Task Decomposition\nä»»åŠ¡åˆ†è§£"]
        Coord["Coordinator\nåè°ƒå™¨"]
        Merge["Result Merger\nç»“æœåˆå¹¶å™¨"]
    end

    %% Dispatch
    subgraph Disp["æ‰§è¡Œåˆ†å‘"]
        Dispatch["Dispatcher\nåˆ†å‘å™¨"]
        Queue["Job Queue\nä»»åŠ¡é˜Ÿåˆ—"]
        Timeout["Timeout Control\nè¶…æ—¶æ§åˆ¶"]
        Retry["Retry Logic\né‡è¯•é€»è¾‘"]
    end

    %% Output Integration
    subgraph Output["è¾“å‡ºæ•´åˆ"]
        MemCtl["Memory Controller\nè®°å¿†æ§åˆ¶å™¨"]
        Audit["Audit Logger\nå®¡è®¡æ—¥å¿—"]
        Patch["Message Patch\næ¶ˆæ¯è¡¥ä¸"]
        Notification["Notification\né€šçŸ¥"]
    end

    %% Cross-cutting
    subgraph Cross["æ¨ªåˆ‡å…³æ³¨ç‚¹"]
        Safety["Safety Guard\nå®‰å…¨é˜²æŠ¤"]
        Observability["Observability\nå¯è§‚æµ‹æ€§"]
    end

    %% Flows
    Event --> CtxBldr
    Approval --> CtxBldr
    Callback --> CtxBldr

    CtxBldr --> Ctx
    Ctx --> Intent
    Ctx --> Trigger

    Trigger --> Explicit
    Trigger --> Implicit
    Explicit --> IT
    Implicit --> IT

    Intent --> Recall
    Explicit --> Recall

    Recall --> CapIndex
    CapIndex --> Recall
    Recall --> Ranker
    Ranker --> Scores
    Scores --> PDP

    PDP --> RBAC
    PDP --> ABAC
    PDP --> Scopes
    PDP --> Planner

    Planner --> Decompose
    Planner --> Coord
    Planner --> Dispatch

    Dispatch --> Queue
    Queue --> Timeout
    Timeout --> Retry
    Retry --> Merge

    Merge --> MemCtl
    Merge --> Patch
    Merge --> Notification

    MemCtl --> Audit
    PDP --> Audit
    Dispatch --> Audit

    Intent --> Safety
    PDP --> Safety
    Dispatch --> Safety

    Intent -.-> Observability
    PDP -.-> Observability
    Dispatch -.-> Observability
```

---

## 2. æ¨¡å—è¯¦è§£

### 2.1 Context Builderï¼ˆä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼‰

**èŒè´£**: ä¸ºäº‹ä»¶å¤„ç†æ„å»ºå®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡

```go
type ContextBuilder interface {
    Build(ctx context.Context, event *MessageEvent) (*ExecutionContext, error)
}

type ExecutionContext struct {
    // äº‹ä»¶åŸºç¡€ä¿¡æ¯
    EventID    string            `json:"event_id"`
    EventType  EventType         `json:"event_type"`
    Timestamp  time.Time         `json:"timestamp"`

    // æ¶ˆæ¯ä¸Šä¸‹æ–‡
    RecentMessages   []*Message   `json:"recent_messages"`   // æœ€è¿‘ N æ¡æ¶ˆæ¯
    ThreadMessages   []*Message   `json:"thread_messages"`   // çº¿ç¨‹ä¸­çš„æ¶ˆæ¯
    ReplyChain       []*Message   `json:"reply_chain"`       // å›å¤é“¾

    // èŠå¤©ä¸Šä¸‹æ–‡
    ChatID       string           `json:"chat_id"`
    ChatType     ChatType         `json:"chat_type"`         // private/group/public
    ChatMetadata map[string]string `json:"chat_metadata"`

    // å‚ä¸è€…ä¿¡æ¯
    Participants []*Participant   `json:"participants"`

    // å…¨å±€è®°å¿†ä¸Šä¸‹æ–‡
    MemoryContext []*MemoryHit    `json:"memory_context"`

    // é¢„è®¡ç®—çš„å±æ€§
    MessageCount     int           `json:"message_count"`
    HasImages        bool          `json:"has_images"`
    HasVideos        bool          `json:"has_videos"`
    MentionedAgents  []string      `json:"mentioned_agents"`
    MentionedUsers   []string      `json:"mentioned_users"`
}
```

**æ„å»ºç­–ç•¥**:

| ä¸Šä¸‹æ–‡ç±»å‹ | è·å–æ–¹å¼ | æ•°é‡é™åˆ¶ |
|----------|----------|----------|
| æœ€è¿‘æ¶ˆæ¯ | ä»æ•°æ®åº“/ç¼“å­˜è¯»å– | 100 æ¡ |
| çº¿ç¨‹æ¶ˆæ¯ | æŒ‰å›å¤é“¾å±•å¼€ | 50 æ¡ |
| ç¾¤ä¿¡æ¯ | ä»ç¼“å­˜è¯»å– | 1 ä¸ª |
| å‚ä¸è€… | ä»æˆå‘˜è¡¨è¯»å– | å…¨éƒ¨ |
| è®°å¿†ä¸Šä¸‹æ–‡ | å‘é‡æ£€ç´¢ | Top 10 |

### 2.2 Intent & Trigger Engineï¼ˆæ„å›¾ä¸è§¦å‘å¼•æ“ï¼‰

**èŒè´£**: è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œå†³å®šæ˜¯å¦è§¦å‘ Agent

```go
type IntentService interface {
    // åˆ†ç±»æ„å›¾
    Classify(ctx context.Context, event *MessageEvent, execCtx *ExecutionContext) (*Intent, error)

    // æ£€æµ‹è§¦å‘
    DetectTriggers(ctx context.Context, event *MessageEvent, execCtx *ExecutionContext) ([]Trigger, error)
}

type Intent struct {
    // æ„å›¾åˆ†ç±»
    Category    IntentCategory `json:"category"`    // qa, summarize, action, search, create, chitchat
    Subcategory string         `json:"subcategory"` // finer-grained category

    // ç½®ä¿¡åº¦
    Confidence  float64        `json:"confidence"`  // 0-1

    // å®ä½“æå–
    Entities    []Entity       `json:"entities"`

    // æ˜¯å¦éœ€è¦ Agent
    NeedsAgent  bool           `json:"needs_agent"`
}

type Trigger struct {
    // è§¦å‘ç±»å‹
    Type        TriggerType    `json:"type"`        // explicit_mention, implicit_intent, keyword

    // è§¦å‘æº
    Source      string         `json:"source"`      // agent_id or intent category

    // è§¦å‘ä½ç½®
    Position    MessagePosition `json:"position"`   // start, middle, end

    // ä¸Šä¸‹æ–‡
    Context     string         `json:"context"`
}

type IntentCategory string

const (
    IntentQA           IntentCategory = "qa"            // é—®ç­”
    IntentSummarize    IntentCategory = "summarize"     // æ€»ç»“
    IntentAction       IntentCategory = "action"        // æ‰§è¡ŒåŠ¨ä½œ
    IntentSearch       IntentCategory = "search"        // æœç´¢
    IntentCreate       IntentCategory = "create"        // åˆ›å»ºå†…å®¹
    IntentChitchat     IntentCategory = "chitchat"      // é—²èŠ
    IntentUnknown      IntentCategory = "unknown"       // æœªçŸ¥
)
```

**è§¦å‘åˆ¤å®šé€»è¾‘**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è§¦å‘åˆ¤å®šæµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  1. æ˜¾å¼ @ æ£€æµ‹                                                â”‚
â”‚     â”œâ”€â”€ è§£ææ¶ˆæ¯ä¸­çš„ @mentions                                 â”‚
â”‚     â”œâ”€â”€ è¿‡æ»¤å‡º @Agentï¼ˆæ’é™¤ @Userï¼‰                            â”‚
â”‚     â””â”€â”€ ç”Ÿæˆ explicit_mention è§¦å‘                            â”‚
â”‚                                                               â”‚
â”‚  2. éšå¼æ„å›¾æ£€æµ‹                                                â”‚
â”‚     â”œâ”€â”€ æ„å›¾åˆ†ç±»ï¼ˆç½®ä¿¡åº¦ > é˜ˆå€¼ï¼‰                               â”‚
â”‚     â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦ä¸º"éœ€è¦ Agent"çš„æ„å›¾ç±»å‹                        â”‚
â”‚     â””â”€â”€ ç”Ÿæˆ implicit_intent è§¦å‘                             â”‚
â”‚                                                               â”‚
â”‚  3. å…³é”®è¯è§¦å‘ï¼ˆå¯é€‰ï¼ŒMVP åï¼‰                                   â”‚
â”‚     â”œâ”€â”€ åŒ¹é…é¢„å®šä¹‰å…³é”®è¯                                       â”‚
â”‚     â””â”€â”€ ç”Ÿæˆ keyword è§¦å‘                                      â”‚
â”‚                                                               â”‚
â”‚  4. è§¦å‘åˆå¹¶ä¸å»é‡                                             â”‚
â”‚     â””â”€â”€ åˆå¹¶æ‰€æœ‰è§¦å‘ï¼Œå»é‡ Agent                               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Agent Recall & Rankerï¼ˆå¬å›ä¸æ’åºï¼‰

**èŒè´£**: ä»å€™é€‰ Agent ä¸­ç­›é€‰å¹¶æ’åº

```go
type RecallEngine interface {
    // å¬å›å€™é€‰ Agent
    Recall(ctx context.Context, intent *Intent, execCtx *ExecutionContext) ([]string, error)
}

type Ranker interface {
    // å¯¹å€™é€‰ Agent æ’åº
    Rank(ctx context.Context, candidates []string, intent *Intent, execCtx *ExecutionContext) ([]*ScoredAgent, error)
}

type ScoredAgent struct {
    AgentID     string   `json:"agent_id"`
    Score       float64  `json:"score"`
    Reasons     []string `json:"reasons"`     // æ‰“åˆ†åŸå› 
    Capabilities []string `json:"capabilities"`
}

// æ‰“åˆ†å…¬å¼
type ScoringConfig struct {
    WeightCapabilityMatch   float64  `json:"weight_capability_match"`   // 0.4
    WeightChatRelevance     float64  `json:"weight_chat_relevance"`     // 0.2
    WeightHistoricalSuccess float64  `json:"weight_historical_success"` // 0.2
    WeightEstimatedCost     float64  `json:"weight_estimated_cost"`     // -0.1
    WeightRiskLevel         float64  `json:"weight_risk_level"`         // -0.1
}
```

**å¬å›ç­–ç•¥**:

| ç­–ç•¥ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| **èƒ½åŠ›åŒ¹é…** | æ ¹æ®æ„å›¾ç±»å‹åŒ¹é… Agent èƒ½åŠ› | summarize â†’ @SummaryAgent |
| **æ˜¾å¼æŒ‡å®š** | ç›´æ¥ä½¿ç”¨ @ çš„ Agent | @ResearchAgent |
| **ç¾¤é…ç½®** | ç¾¤å†…å¯ç”¨çš„ Agent | ç¾¤é…ç½®çš„é»˜è®¤ Agent |
| **å†å²åå¥½** | ç”¨æˆ·/ç¾¤å¸¸ç”¨çš„ Agent | è¿‡å» 7 å¤©ä½¿ç”¨æœ€å¤šçš„ |

**æ’åºå› å­**:

```
æœ€ç»ˆå¾—åˆ† = Î£(æƒé‡ Ã— å› å­)

å› å­ = {
  èƒ½åŠ›åŒ¹é…åº¦:    [0, 1]
  èŠå¤©ç›¸å…³åº¦:    [0, 1]
  å†å²æˆåŠŸç‡:    [0, 1]
  ä¼°ç®—æˆæœ¬:      [0, 1] (æƒ©ç½šé¡¹)
  é£é™©è¯„åˆ†:      [0, 1] (æƒ©ç½šé¡¹)
}
```

### 2.4 Policy Decision Point (PDP)ï¼ˆç­–ç•¥å†³ç­–ç‚¹ï¼‰

**èŒè´£**: æƒé™æ§åˆ¶ä¸å®‰å…¨ç­–ç•¥

```go
type PDPService interface {
    // è¯„ä¼°è¯·æ±‚æ˜¯å¦å…è®¸
    Evaluate(ctx context.Context, req *PolicyRequest) (*PolicyDecision, error)

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·å®¡æ‰¹
    RequiresApproval(ctx context.Context, req *PolicyRequest) (bool, *ApprovalTemplate, error)
}

type PolicyRequest struct {
    // ä¸»ä½“
    Subject     Subject         `json:"subject"`     // who

    // åŠ¨ä½œ
    Action      Action          `json:"action"`      // what

    // èµ„æº
    Resource    Resource        `json:"resource"`    // target

    // ç¯å¢ƒ
    Environment Environment     `json:"environment"` // context
}

type Subject struct {
    ID         string          `json:"id"`
    Type       SubjectType     `json:"type"`         // user, agent
    Attributes map[string]string `json:"attributes"`
}

type Action struct {
    Category    ActionCategory  `json:"category"`     // read, write, execute
    Operation   string          `json:"operation"`    // read_memory, write_memory, send_email, ...
    Tool        *string         `json:"tool,omitempty"` // å…·ä½“å·¥å…·
}

type Resource struct {
    Type       ResourceType    `json:"type"`         // message, memory, task, external_system
    ID         string          `json:"id"`
    Scope      string          `json:"scope"`        // global, chat, user
}

type PolicyDecision struct {
    Effect      Effect          `json:"effect"`       // allow, deny
    Reason      string          `json:"reason"`
    Constraints []Constraint    `json:"constraints"`
}

type Effect string

const (
    EffectAllow         Effect = "allow"
    EffectDeny          Effect = "deny"
    EffectRequireApproval Effect = "require_approval"
)
```

**ç­–ç•¥è§„åˆ™ç¤ºä¾‹**:

```yaml
# Agent é»˜è®¤ç­–ç•¥
agent_policies:
  # è¯»æ¶ˆæ¯
  - id: AP-001
    subject:
      type: agent
    action:
      category: read
      operation: read_messages
    resource:
      type: message
      scope: chat
    effect: allow
    condition: agent_in_chat

  # å†™è®°å¿†
  - id: AP-002
    subject:
      type: agent
    action:
      category: write
      operation: write_memory
    resource:
      type: memory
    effect: require_approval
    condition: chat_admin_enabled

  # å¤–éƒ¨æ“ä½œ
  - id: AP-003
    subject:
      type: agent
    action:
      category: execute
      operation: external_action
    resource:
      type: external_system
    effect: require_approval
    always: true
```

### 2.5 Plannerï¼ˆè§„åˆ’å™¨ï¼‰

**èŒè´£**: ä»»åŠ¡åˆ†è§£ä¸æ‰§è¡Œè®¡åˆ’

```go
type Planner interface {
    // ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
    Plan(ctx context.Context, intent *Intent, agents []*ScoredAgent, execCtx *ExecutionContext) (*ExecutionPlan, error)
}

type ExecutionPlan struct {
    PlanID      string          `json:"plan_id"`

    // ä»»åŠ¡åˆ—è¡¨
    Tasks       []*AgentTask    `json:"tasks"`

    // æ‰§è¡Œç­–ç•¥
    Strategy    ExecutionStrategy `json:"strategy"`    // sequential, parallel, pipeline

    // è¶…æ—¶æ§åˆ¶
    Timeout     time.Duration   `json:"timeout"`

    // åˆå¹¶ç­–ç•¥
    MergeStrategy MergeStrategy  `json:"merge_strategy"` // best_of, consensus, primary_reviewer
}

type AgentTask struct {
    TaskID      string          `json:"task_id"`
    AgentID     string          `json:"agent_id"`
    Instruction string          `json:"instruction"`
    Context     TaskContext     `json:"context"`
    DependsOn   []string        `json:"depends_on"`   // ä¾èµ–çš„ä»»åŠ¡ ID
    Timeout     time.Duration   `json:"timeout"`
    Retry       int             `json:"retry"`
}

type ExecutionStrategy string

const (
    StrategySequential ExecutionStrategy = "sequential"  // é¡ºåºæ‰§è¡Œ
    StrategyParallel   ExecutionStrategy = "parallel"    // å¹¶è¡Œæ‰§è¡Œ
    StrategyPipeline   ExecutionStrategy = "pipeline"    // æµæ°´çº¿
)

type MergeStrategy string

const (
    MergeBestOf       MergeStrategy = "best_of"         // é€‰æœ€å¥½çš„
    MergeConsensus     MergeStrategy = "consensus"       // å…±è¯†
    MergePrimaryReview MergeStrategy = "primary_review" // ä¸»å®¡æ¨¡å¼
    MergeAll           MergeStrategy = "all"             // å…¨éƒ¨è¿”å›
)
```

**ä»»åŠ¡åˆ†è§£ç¤ºä¾‹**:

```
åŸå§‹è¯·æ±‚: "@ResearchAgent å¸®æˆ‘æ‰¾ä¸€ä¸‹ç«å“å·®å¼‚ï¼Œå¹¶æ€»ç»“æˆè¡¨æ ¼"

ä»»åŠ¡åˆ†è§£:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 1: ç«å“ä¿¡æ¯æœé›†                                         â”‚
â”‚  â”œâ”€â”€ Agent: @ResearchAgent                                   â”‚
â”‚  â”œâ”€â”€ Instruction: "æœç´¢ä»¥ä¸‹ç«å“çš„å·®å¼‚: Slack, Teams, WeChat" â”‚
â”‚  â””â”€â”€ Output: ç«å“ä¿¡æ¯åˆ—è¡¨                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Task 2: è¡¨æ ¼ç”Ÿæˆ                                             â”‚
â”‚  â”œâ”€â”€ Agent: @SummaryAgent                                     â”‚
â”‚  â”œâ”€â”€ Instruction: "å°†ç«å“ä¿¡æ¯æ•´ç†æˆå¯¹æ¯”è¡¨æ ¼"                   â”‚
â”‚  â”œâ”€â”€ DependsOn: Task 1                                        â”‚
â”‚  â””â”€â”€ Output: Markdown è¡¨æ ¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6 Dispatcherï¼ˆåˆ†å‘å™¨ï¼‰

**èŒè´£**: ä»»åŠ¡åˆ†å‘ä¸æ‰§è¡Œæ§åˆ¶

```go
type Dispatcher interface {
    // æ‰§è¡Œè®¡åˆ’
    Dispatch(ctx context.Context, plan *ExecutionPlan) (*DispatchResult, error)

    // å–æ¶ˆæ‰§è¡Œ
    Cancel(ctx context.Context, planID string) error
}

type DispatchResult struct {
    PlanID       string            `json:"plan_id"`
    Status       DispatchStatus    `json:"status"`
    Results      []*TaskResult     `json:"results"`
    Errors       []error           `json:"errors"`
    StartTime    time.Time         `json:"start_time"`
    EndTime      time.Time         `json:"end_time"`
}

type TaskResult struct {
    TaskID      string            `json:"task_id"`
    AgentID     string            `json:"agent_id"`
    Status      TaskStatus        `json:"status"`
    Response    string            `json:"response"`
    Citations   []string          `json:"citations"`
    ActionItems []*ActionItem     `json:"action_items"`
    Error       error             `json:"error,omitempty"`
}

type DispatchStatus string

const (
    DispatchPending   DispatchStatus = "pending"
    DispatchRunning   DispatchStatus = "running"
    DispatchCompleted DispatchStatus = "completed"
    DispatchFailed    DispatchStatus = "failed"
    DispatchCancelled DispatchStatus = "cancelled"
)
```

### 2.7 Result Mergerï¼ˆç»“æœåˆå¹¶å™¨ï¼‰

**èŒè´£**: åˆå¹¶å¤šä¸ª Agent çš„ç»“æœ

```go
type Merger interface {
    // åˆå¹¶ç»“æœ
    Merge(ctx context.Context, results []*TaskResult, strategy MergeStrategy) (*MergedResult, error)
}

type MergedResult struct {
    Response     string            `json:"response"`
    Citations    []string          `json:"citations"`
    ActionItems  []*ActionItem     `json:"action_items"`
    Provenance   map[string]string `json:"provenance"` // å¼•ç”¨æº¯æº
    Confidence   float64           `json:"confidence"`
}
```

**åˆå¹¶ç­–ç•¥è¯¦è§£**:

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ç®—æ³• |
|------|----------|------|
| **best_of** | æ€»ç»“ç±» | é€‰æ‹©æœ€å…¨é¢ä¸”æœ€å°‘çš„å¹»è§‰ç»“æœ |
| **consensus** | è¡ŒåŠ¨ç±» | å¤šæ•°ä¸€è‡´æ‰æ‰§è¡Œï¼Œå¦åˆ™ç¡®è®¤ |
| **primary_reviewer** | ä»£ç ç±» | ä¸» Agent ç”Ÿæˆï¼Œå®¡æ ¸ Agent æ£€æŸ¥ |
| **all** | åˆ›æ„ç±» | å…¨éƒ¨å±•ç¤ºï¼Œè®©ç”¨æˆ·é€‰æ‹© |

### 2.8 Memory Controllerï¼ˆè®°å¿†æ§åˆ¶å™¨ï¼‰

**èŒè´£**: æ§åˆ¶å…¨å±€è®°å¿†çš„è¯»å†™

```go
type MemoryController interface {
    // è¯»å–ç›¸å…³è®°å¿†
    Fetch(ctx context.Context, query string, scope MemoryScope) ([]*MemoryHit, error)

    // å†™å…¥è®°å¿†
    Write(ctx context.Context, entry *MemoryEntry) (string, error)

    // æ‰¹é‡å†™å…¥
    WriteBatch(ctx context.Context, entries []*MemoryEntry) ([]string, error)
}

type MemoryHit struct {
    Entry      *MemoryEntry    `json:"entry"`
    Score      float64         `json:"score"`      // ç›¸å…³æ€§å¾—åˆ†
    Provenance string          `json:"provenance"` // æ¥æºè¯´æ˜
}
```

### 2.9 Audit Loggerï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

**èŒè´£**: è®°å½•æ‰€æœ‰å†³ç­–å’Œæ“ä½œ

```go
type AuditLogger interface {
    // è®°å½•å†³ç­–
    LogDecision(ctx context.Context, decision *DecisionLog) error

    // è®°å½•æ“ä½œ
    LogAction(ctx context.Context, action *ActionLog) error
}

type DecisionLog struct {
    DecisionID  string            `json:"decision_id"`
    EventID     string            `json:"event_id"`
    Timestamp   time.Time         `json:"timestamp"`

    // å†³ç­–å†…å®¹
    Intent      *Intent           `json:"intent"`
    Agents      []string          `json:"agents_selected"`
    Policy      *PolicyDecision   `json:"policy_decision"`

    // æº¯æº
    Provenance  map[string]string `json:"provenance"`
}

type ActionLog struct {
    ActionID    string            `json:"action_id"`
    Actor       string            `json:"actor"`       // user_id or agent_id
    ActorType   SubjectType       `json:"actor_type"`
    Action      string            `json:"action"`
    Target      string            `json:"target"`
    Timestamp   time.Time         `json:"timestamp"`
    PayloadHash string            `json:"payload_hash"`
}
```

---

## 3. æ ¸å¿ƒæ¥å£

### 3.1 ä¸»å¤„ç†æ¥å£

```go
type SocialBrain interface {
    // å¤„ç†æ¶ˆæ¯äº‹ä»¶
    HandleMessageEvent(ctx context.Context, event *MessageEvent) (*OrchestrationResult, error)

    // å¤„ç†å®¡æ‰¹å›è°ƒ
    HandleApproval(ctx context.Context, approval *ApprovalRequest) error

    // å¤„ç† Agent å›è°ƒ
    HandleAgentCallback(ctx context.Context, callback *AgentCallback) error
}

type OrchestrationResult struct {
    // ç»“æœç±»å‹
    Type        ResultType       `json:"type"`

    // Agent ç»“æœ
    AgentResults []*AgentResult  `json:"agent_results,omitempty"`

    // è®°å¿†å†™å…¥
    MemoryWrites []*MemoryEntry  `json:"memory_writes,omitempty"`

    // ä»»åŠ¡åˆ›å»º
    TaskCreates []*Task          `json:"task_creates,omitempty"`

    // éœ€è¦å®¡æ‰¹
    ApprovalRequired *ApprovalTemplate `json:"approval_required,omitempty"`
}

type ResultType string

const (
    ResultAgentReply       ResultType = "agent_reply"
    ResultMemoryWrite      ResultType = "memory_write"
    ResultTaskCreate       ResultType = "task_create"
    ResultApprovalRequired ResultType = "approval_required"
    ResultNoAction         ResultType = "no_action"
)
```

### 3.2 å†…éƒ¨é€šä¿¡æ¥å£

```protobuf
// gRPC æœåŠ¡å®šä¹‰
service SocialBrain {
    // å¤„ç†äº‹ä»¶
    rpc HandleEvent(EventRequest) returns (EventResponse);

    // æŸ¥è¯¢çŠ¶æ€
    rpc GetStatus(StatusRequest) returns (StatusResponse);

    // å–æ¶ˆæ“ä½œ
    rpc Cancel(CancelRequest) returns (CancelResponse);
}

message EventRequest {
    string event_id = 1;
    google.protobuf.Any event = 2;  // MessageEvent, ApprovalEvent, CallbackEvent
    map<string, string> metadata = 3;
}

message EventResponse {
    bool accepted = 1;
    string result_id = 2;
    repeated string action_ids = 3;  // å¯ç”¨äºè·Ÿè¸ª/å–æ¶ˆ
}
```

---

## 4. å†³ç­–æµç¨‹

### 4.1 å®Œæ•´å†³ç­–æµç¨‹å›¾

```mermaid
flowchart TD
    Start([æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶]) --> BuildCtx[æ„å»ºä¸Šä¸‹æ–‡]

    BuildCtx --> Detect[æ£€æµ‹è§¦å‘]
    Detect --> HasTriggers{æœ‰è§¦å‘?}

    HasTriggers -->|æ— | NoAction[æ— æ“ä½œ]
    HasTriggers -->|æœ‰| Recall[å¬å›å€™é€‰ Agent]

    Recall --> Rank[æ’åºæ‰“åˆ†]
    Rank --> SelectTop[é€‰æ‹© Top N]

    SelectTop --> CheckPDP[PDP æƒé™æ£€æŸ¥]

    CheckPDP --> PDPDecision{å†³ç­–}
    PDPDecision -->|Deny| LogDenied[è®°å½•æ‹’ç»æ—¥å¿—]
    PDPDecision -->|Require Approval| CreateApproval[åˆ›å»ºå®¡æ‰¹]
    PDPDecision -->|Allow| Planning[è§„åˆ’ä»»åŠ¡]

    CreateApproval --> WaitForApproval[ç­‰å¾…å®¡æ‰¹]
    WaitForApproval --> Approved{ç”¨æˆ·æ‰¹å‡†?}
    Approved -->|æ˜¯| Planning
    Approved -->|å¦| LogDenied

    Planning --> GeneratePlan[ç”Ÿæˆæ‰§è¡Œè®¡åˆ’]
    GeneratePlan --> Dispatch[åˆ†å‘æ‰§è¡Œ]

    Dispatch --> Execute[æ‰§è¡Œ Agent Job]
    Execute --> Collect[æ”¶é›†ç»“æœ]

    Collect --> Merge[åˆå¹¶ç»“æœ]
    Merge --> WriteMemory[å†™å…¥è®°å¿†]
    WriteMemory --> WriteAudit[å†™å…¥å®¡è®¡]
    WriteAudit --> SendReply[å‘é€å›å¤]
    SendReply --> End([å®Œæˆ])

    LogDenied --> End
    NoAction --> End
```

### 4.2 å†³ç­–è¡¨

| æ¡ä»¶ | åŠ¨ä½œ |
|------|------|
| æ—  @ ä¸”æ„å›¾ç½®ä¿¡åº¦ < é˜ˆå€¼ | æ— æ“ä½œ |
| æœ‰ @ ä½† Agent ä¸åœ¨ç¾¤ | æç¤ºç”¨æˆ· |
| æœ‰ @ ä½†æƒé™ä¸è¶³ | è¯·æ±‚å®¡æ‰¹æˆ–æ‹’ç» |
| æœ‰ @ ä¸”æƒé™å…è®¸ | æ‰§è¡Œ Agent Job |
| éšå¼è§¦å‘ä¸”é«˜é£é™© | è¯·æ±‚ç¡®è®¤ |
| éšå¼è§¦å‘ä¸”ä½é£é™© | è‡ªåŠ¨æ‰§è¡Œ |

---

## 5. å¼‚å¸¸å¤„ç†

### 5.1 å¼‚å¸¸ç±»å‹ä¸å¤„ç†ç­–ç•¥

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ |
|----------|----------|
| **è¶…æ—¶** | å–æ¶ˆä»»åŠ¡ï¼Œè¿”å›éƒ¨åˆ†ç»“æœï¼ˆå¦‚æœ‰ï¼‰ï¼Œè®°å½•æ—¥å¿— |
| **Agent å¤±è´¥** | é‡è¯•ï¼ˆæœ‰é™æ¬¡æ•°ï¼‰ï¼Œé™çº§åˆ°å…¶ä»– Agent |
| **PDP æ‹’ç»** | è®°å½•åŸå› ï¼Œé€šçŸ¥ç”¨æˆ· |
| **ç”¨æˆ·æ‹’ç»å®¡æ‰¹** | å–æ¶ˆä»»åŠ¡ï¼Œè®°å½•æ—¥å¿— |
| **ç³»ç»Ÿè¿‡è½½** | è¿”å›é™çº§æœåŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ç¨åå¤„ç† |

### 5.2 é‡è¯•ç­–ç•¥

```go
type RetryPolicy struct {
    MaxAttempts  int           `json:"max_attempts"`  // æœ€å¤§å°è¯•æ¬¡æ•°
    InitialDelay time.Duration `json:"initial_delay"` // åˆå§‹å»¶è¿Ÿ
    MaxDelay     time.Duration `json:"max_delay"`     // æœ€å¤§å»¶è¿Ÿ
    Multiplier   float64       `json:"multiplier"`    // å»¶è¿Ÿå€æ•°
    BackoffType  BackoffType   `json:"backoff_type"`  // fixed, exponential
}

type BackoffType string

const (
    BackoffFixed       BackoffType = "fixed"
    BackoffExponential BackoffType = "exponential"
)

// é»˜è®¤ç­–ç•¥
var DefaultRetryPolicy = &RetryPolicy{
    MaxAttempts:  3,
    InitialDelay: 1 * time.Second,
    MaxDelay:     30 * time.Second,
    Multiplier:   2.0,
    BackoffType:  BackoffExponential,
}
```

---

## ğŸ·ï¸ æ ‡ç­¾

`#Social Brain` `#ç¼–æ’æ¶æ„` `#æ„å›¾è¯†åˆ«` `#æƒé™æ§åˆ¶` `#å†³ç­–æµç¨‹`

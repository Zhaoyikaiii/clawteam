# ClawTeam - æ•°æ®æ¨¡å‹è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2026-02-14
> **æ•°æ®åº“**: PostgreSQL (ä¸»åº“) + Qdrant (å‘é‡)

## ğŸ“‹ ç›®å½•

- [1. æ•°æ®åº“æ¦‚è§ˆ](#1-æ•°æ®åº“æ¦‚è§ˆ)
- [2. æ ¸å¿ƒè¡¨è®¾è®¡](#2-æ ¸å¿ƒè¡¨è®¾è®¡)
- [3. å‘é‡å­˜å‚¨](#3-å‘é‡å­˜å‚¨)
- [4. API è®¾è®¡](#4-api-è®¾è®¡)
- [5. æ•°æ®è¿ç§»](#5-æ•°æ®è¿ç§»)

---

## 1. æ•°æ®åº“æ¦‚è§ˆ

### 1.1 æ•°æ®å­˜å‚¨æ¶æ„

```mermaid
flowchart LR
    subgraph SQL["å…³ç³»å‹æ•°æ®åº“ (PostgreSQL)"]
        M[messages]
        C[chats]
        A[agents]
        ME[memory_entries]
        T[tasks]
        AL[audit_logs]
        U[users]
    end

    subgraph Vector["å‘é‡æ•°æ®åº“ (Qdrant)"]
        V1[message_embeddings]
        V2[memory_embeddings]
    end

    subgraph NATS["NATS JetStream"]
        MQ[æ¶ˆæ¯é˜Ÿåˆ—]
        KV[é”®å€¼å­˜å‚¨]
        OBJ[å¯¹è±¡å­˜å‚¨]
    end

    subgraph Object["å¯¹è±¡å­˜å‚¨ (MinIO/S3)"]
        Files[æ–‡ä»¶é™„ä»¶]
        Media[åª’ä½“æ–‡ä»¶]
    end

    SQL <--> Vector
    SQL <--> NATS
    NATS <--> Object
```

### 1.2 è¡¨åˆ†ç±»

| ç±»åˆ« | è¡¨å | ç”¨é€” |
|------|------|------|
| **ç”¨æˆ·ä¸ç¾¤ç»„** | users, chats, chat_members | åŸºç¡€ç¤¾äº¤å…³ç³» |
| **æ¶ˆæ¯** | messages, attachments | æ¶ˆæ¯å­˜å‚¨ |
| **Agent** | agents, agent_capabilities, agent_configs | Agent ç®¡ç† |
| **è®°å¿†** | memory_entries, memory_tags, memory_links | å…¨å±€è®°å¿† |
| **ä»»åŠ¡** | tasks, task_assignments | ä»»åŠ¡ç®¡ç† |
| **å®¡è®¡** | audit_logs, approvals | å®¡è®¡è¿½è¸ª |

---

## 2. æ ¸å¿ƒè¡¨è®¾è®¡

### 2.1 ç”¨æˆ·ä¸ç¾¤ç»„

#### users

```sql
CREATE TABLE users (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- åŸºæœ¬ä¿¡æ¯
    username        VARCHAR(32) UNIQUE NOT NULL,
    display_name    VARCHAR(128) NOT NULL,
    email           VARCHAR(255) UNIQUE,
    phone           VARCHAR(32),

    -- è®¤è¯
    password_hash   VARCHAR(255),  -- bcrypt
    avatar_url      VARCHAR(512),

    -- çŠ¶æ€
    status          VARCHAR(16) DEFAULT 'active',  -- active, suspended, deleted
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),
    last_seen_at    TIMESTAMPTZ,

    -- ç´¢å¼•
    CONSTRAINT status_check CHECK (status IN ('active', 'suspended', 'deleted'))
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status) WHERE status != 'active';
```

#### chats

```sql
CREATE TYPE chat_type AS ENUM ('direct', 'group', 'channel');

CREATE TABLE chats (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- åŸºæœ¬ä¿¡æ¯
    type            chat_type NOT NULL,
    name            VARCHAR(128),  -- ç¾¤å (private/group å¯é€‰)
    description     TEXT,

    -- ç¾¤ç»„è®¾ç½®
    avatar_url      VARCHAR(512),
    is_public       BOOLEAN DEFAULT false,

    -- Agent è®¾ç½®
    agent_memory_enabled BOOLEAN DEFAULT false,  -- Agent æ˜¯å¦å¯å†™è®°å¿†
    default_agents  JSONB DEFAULT '[]'::jsonb,      -- é»˜è®¤å¯ç”¨çš„ Agent IDs

    -- å…ƒæ•°æ®
    metadata        JSONB DEFAULT '{}'::jsonb,
    created_by      UUID REFERENCES users(id),

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),

    -- è½¯åˆ é™¤
    deleted_at      TIMESTAMPTZ
);

CREATE INDEX idx_chats_type ON chats(type);
CREATE INDEX idx_chats_created_by ON chats(created_by);
CREATE INDEX idx_chats_deleted_at ON chats(deleted_at) WHERE deleted_at IS NULL;
```

#### chat_members

```sql
CREATE TYPE member_role AS ENUM ('owner', 'admin', 'member');

CREATE TABLE chat_members (
    -- å¤åˆä¸»é”®
    chat_id         UUID REFERENCES chats(id) ON DELETE CASCADE,
    user_id         UUID REFERENCES users(id) ON DELETE CASCADE,

    -- æˆå‘˜ä¿¡æ¯
    role            member_role DEFAULT 'member',
    display_name    VARCHAR(128),  -- ç¾¤å†…æ˜µç§°

    -- é€šçŸ¥è®¾ç½®
    mute_until      TIMESTAMPTZ,
    mention_enabled BOOLEAN DEFAULT true,

    -- æ—¶é—´æˆ³
    joined_at       TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),

    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (chat_id, user_id)
);

CREATE INDEX idx_chat_members_user_id ON chat_members(user_id);
CREATE INDEX idx_chat_members_role ON chat_members(role);
```

### 2.2 æ¶ˆæ¯

#### messages

```sql
CREATE TYPE sender_type AS ENUM ('user', 'agent', 'system');

CREATE TABLE messages (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- å…³è”
    chat_id         UUID NOT NULL REFERENCES chats(id) ON DELETE CASCADE,

    -- å‘é€è€…
    sender_type     sender_type NOT NULL,
    sender_id       VARCHAR(128) NOT NULL,  -- user UUID or agent_id

    -- å†…å®¹
    content_type    VARCHAR(32) DEFAULT 'text',  -- text, image, video, file
    content         TEXT NOT NULL,

    -- å…³è”
    reply_to        UUID REFERENCES messages(id),  -- å›å¤çš„æ¶ˆæ¯
    thread_root     UUID REFERENCES messages(id),  -- çº¿ç¨‹æ ¹æ¶ˆæ¯

    -- é™„ä»¶
    attachments     JSONB DEFAULT '[]'::jsonb,

    -- å…ƒæ•°æ®
    mentions        JSONB DEFAULT '[]'::jsonb,     -- @users, @agents
    metadata        JSONB DEFAULT '{}'::jsonb,

    -- çŠ¶æ€
    is_deleted      BOOLEAN DEFAULT false,
    deleted_at      TIMESTAMPTZ,

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),

    -- å…¨æ–‡æœç´¢
    tsv             TSVECTOR GENERATED ALWAYS AS (to_tsvector('english', content)) STORED
);

CREATE INDEX idx_messages_chat_id_created_at ON messages(chat_id, created_at DESC);
CREATE INDEX idx_messages_sender ON messages(sender_type, sender_id);
CREATE INDEX idx_messages_reply_to ON messages(reply_to) WHERE reply_to IS NOT NULL;
CREATE INDEX idx_messages_thread_root ON messages(thread_root) WHERE thread_root IS NOT NULL;
CREATE INDEX idx_messages_tsv ON messages USING GIN(tsv);
CREATE INDEX idx_messages_deleted_at ON messages(deleted_at) WHERE deleted_at IS NULL;
```

### 2.3 Agent

#### agents

```sql
CREATE TYPE agent_template AS ENUM ('summary', 'research', 'task', 'custom');

CREATE TABLE agents (
    -- ä¸»é”®
    id              VARCHAR(64) PRIMARY KEY,  -- å¦‚: summary_agent, user_abc_agent

    -- åŸºæœ¬ä¿¡æ¯
    name            VARCHAR(128) NOT NULL,
    description     TEXT,
    template        agent_template NOT NULL,

    -- æ‰€æœ‰è€…
    owner_id        UUID REFERENCES users(id),

    -- é…ç½®
    system_prompt    TEXT NOT NULL,
    model_config    JSONB NOT NULL,  -- model_name, temperature, max_tokens, etc.

    -- èƒ½åŠ›å£°æ˜
    capabilities    JSONB NOT NULL DEFAULT '[]'::jsonb,  -- ["summarize", "search"]

    -- ä½œç”¨åŸŸ
    scope_type      VARCHAR(16) DEFAULT 'selected',  -- all, selected
    scope_chats     JSONB DEFAULT '[]'::jsonb,        -- å¯è®¿é—®çš„ chat_ids

    -- æƒé™
    can_write_memory BOOLEAN DEFAULT false,
    can_create_tasks BOOLEAN DEFAULT true,
    can_external_action BOOLEAN DEFAULT false,

    -- å¤–éƒ¨é›†æˆ
    external_tools  JSONB DEFAULT '[]'::jsonb,  -- [{type: "gmail", scopes: ["read"]}]

    -- çŠ¶æ€
    is_active       BOOLEAN DEFAULT true,
    is_public       BOOLEAN DEFAULT false,

    -- ç»Ÿè®¡
    usage_count     BIGINT DEFAULT 0,

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),

    -- è½¯åˆ é™¤
    deleted_at      TIMESTAMPTZ
);

CREATE INDEX idx_agents_owner_id ON agents(owner_id);
CREATE INDEX idx_agents_template ON agents(template);
CREATE INDEX idx_agents_is_active ON agents(is_active) WHERE is_active = true;
CREATE INDEX idx_agents_deleted_at ON agents(deleted_at) WHERE deleted_at IS NULL;
```

#### agent_stats

```sql
CREATE TABLE agent_stats (
    -- ä¸»é”®
    id              BIGSERIAL PRIMARY KEY,

    -- Agent
    agent_id        VARCHAR(64) REFERENCES agents(id) ON DELETE CASCADE,

    -- ç»Ÿè®¡çª—å£ (æŒ‰å¤©)
    date            DATE NOT NULL,

    -- ç»Ÿè®¡æŒ‡æ ‡
    call_count      BIGINT DEFAULT 0,
    success_count   BIGINT DEFAULT 0,
    error_count     BIGINT DEFAULT 0,

    -- Token ä½¿ç”¨
    total_input_tokens  BIGINT DEFAULT 0,
    total_output_tokens BIGINT DEFAULT 0,

    -- æˆæœ¬
    total_cost      NUMERIC(10, 4) DEFAULT 0,

    -- ç”¨æˆ·æ»¡æ„åº¦
    avg_satisfaction NUMERIC(3, 2),  -- 0.00 - 5.00

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW(),

    -- å”¯ä¸€çº¦æŸ
    UNIQUE (agent_id, date)
);

CREATE INDEX idx_agent_stats_agent_id_date ON agent_stats(agent_id, date DESC);
```

### 2.4 è®°å¿†

#### memory_entries

```sql
CREATE TYPE memory_type AS ENUM ('summary', 'decision', 'action', 'knowledge');
CREATE TYPE memory_scope AS ENUM ('global', 'chat', 'user');
CREATE TYPE memory_status AS ENUM ('active', 'deprecated', 'deleted');

CREATE TABLE memory_entries (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- ç±»å‹
    type            memory_type NOT NULL,
    scope           memory_scope NOT NULL,

    -- å…³è”
    chat_id         UUID REFERENCES chats(id) ON DELETE CASCADE,
    user_id         UUID REFERENCES users(id) ON DELETE CASCADE,  -- åˆ›å»ºè€…

    -- å†…å®¹
    title           VARCHAR(256),
    summary_text    TEXT NOT NULL,
    content         TEXT,

    -- æ¥æº
    source_type     VARCHAR(16),  -- message, agent, manual
    source_id       VARCHAR(128),
    source_message_ids JSONB DEFAULT '[]'::jsonb,

    -- ç»„ç»‡
    tags            JSONB DEFAULT '[]'::jsonb,
    links           JSONB DEFAULT '[]'::jsonb,  -- å…³è”çš„å…¶ä»–è®°å¿†

    -- å‘é‡ (å­˜å‚¨ embedding)
    embedding_id    VARCHAR(128),  -- æŒ‡å‘å‘é‡æ•°æ®åº“

    -- ç”Ÿå‘½å‘¨æœŸ
    status          memory_status DEFAULT 'active',
    expires_at      TIMESTAMPTZ,

    -- è®¿é—®ç»Ÿè®¡
    access_count    INT DEFAULT 0,

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_memory_entries_type ON memory_entries(type);
CREATE INDEX idx_memory_entries_scope ON memory_entries(scope);
CREATE INDEX idx_memory_entries_chat_id ON memory_entries(chat_id) WHERE chat_id IS NOT NULL;
CREATE INDEX idx_memory_entries_user_id ON memory_entries(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_memory_entries_status ON memory_entries(status) WHERE status = 'active';
CREATE INDEX idx_memory_entries_created_at ON memory_entries(created_at DESC);

-- å…¨æ–‡æœç´¢
CREATE INDEX idx_memory_entries_summary_tsv ON memory_entries
    USING GIN(to_tsvector('english', summary_text));
```

#### memory_tags

```sql
CREATE TABLE memory_tags (
    id              SERIAL PRIMARY KEY,
    name            VARCHAR(64) UNIQUE NOT NULL,
    description     TEXT,
    usage_count     INT DEFAULT 0,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_memory_tags_name ON memory_tags(name);
CREATE INDEX idx_memory_tags_usage ON memory_tags(usage_count DESC);
```

### 2.5 ä»»åŠ¡

#### tasks

```sql
CREATE TYPE task_status AS ENUM ('open', 'in_progress', 'done', 'cancelled');
CREATE TYPE task_priority AS ENUM ('low', 'medium', 'high', 'urgent');

CREATE TABLE tasks (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- å…³è”
    chat_id         UUID NOT NULL REFERENCES chats(id) ON DELETE CASCADE,

    -- åŸºæœ¬ä¿¡æ¯
    title           VARCHAR(256) NOT NULL,
    description     TEXT,

    -- åˆ†é…
    assignee_id     UUID REFERENCES users(id),
    agent_id        VARCHAR(64) REFERENCES agents(id),  -- ç”±å“ªä¸ª Agent åˆ›å»º

    -- æ¥æº
    source_message_id UUID REFERENCES messages(id),

    -- çŠ¶æ€
    status          task_status DEFAULT 'open',
    priority        task_priority DEFAULT 'medium',

    -- æ—¶é—´
    due_date        TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,

    -- å…ƒæ•°æ®
    metadata        JSONB DEFAULT '{}'::jsonb,

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_tasks_chat_id ON tasks(chat_id);
CREATE INDEX idx_tasks_assignee_id ON tasks(assignee_id) WHERE assignee_id IS NOT NULL;
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;
CREATE INDEX idx_tasks_created_at ON tasks(created_at DESC);
```

### 2.6 å®¡è®¡

#### audit_logs

```sql
CREATE TABLE audit_logs (
    -- ä¸»é”®
    id              BIGSERIAL PRIMARY KEY,

    -- æ“ä½œè€…
    actor_type      VARCHAR(16) NOT NULL,  -- user, agent, system
    actor_id        VARCHAR(128) NOT NULL,

    -- æ“ä½œ
    action          VARCHAR(64) NOT NULL,
    category        VARCHAR(32),  -- message, memory, task, agent

    -- ç›®æ ‡
    target_type     VARCHAR(32),
    target_id       VARCHAR(128),

    -- å†…å®¹å“ˆå¸Œ (é˜²ç¯¡æ”¹)
    payload_hash    VARCHAR(64),

    -- è¯¦æƒ…
    details         JSONB DEFAULT '{}'::jsonb,

    -- æº¯æº
    provenance      JSONB DEFAULT '[]'::jsonb,  -- æ¥æº IDs

    -- ç»“æœ
    result          VARCHAR(16),  -- success, failure, partial

    -- æ—¶é—´æˆ³
    timestamp       TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_actor ON audit_logs(actor_type, actor_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_target ON audit_logs(target_type, target_id);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_logs_result ON audit_logs(result);
```

#### approvals

```sql
CREATE TYPE approval_status AS ENUM ('pending', 'approved', 'rejected', 'expired');

CREATE TABLE approvals (
    -- ä¸»é”®
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- è¯·æ±‚è€…
    requester_id    UUID REFERENCES users(id) NOT NULL,
    requester_type   VARCHAR(16) NOT NULL,  -- user, agent

    -- å®¡æ‰¹è€…
    approver_id     UUID REFERENCES users(id),

    -- å®¡æ‰¹å†…å®¹
    title           VARCHAR(256) NOT NULL,
    description     TEXT NOT NULL,

    -- å…³è”çš„æ“ä½œ
    target_action   JSONB NOT NULL,  -- {agent_id, action, params}

    -- çŠ¶æ€
    status          approval_status DEFAULT 'pending',

    -- æœ‰æ•ˆæœŸ
    expires_at      TIMESTAMPTZ NOT NULL,

    -- å†³ç­–
    decided_at      TIMESTAMPTZ,
    decision_reason  TEXT,

    -- æ—¶é—´æˆ³
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_approvals_requester ON approvals(requester_id, status);
CREATE INDEX idx_approvals_approver ON approvals(approver_id, status);
CREATE INDEX idx_approvals_status ON approvals(status);
CREATE INDEX idx_approvals_expires_at ON approvals(expires_at) WHERE status = 'pending';
```

---

## 3. å‘é‡å­˜å‚¨

### 3.1 Qdrant Collections

#### messages_embeddings

```json
{
  "collection_name": "messages_embeddings",
  "vectors": {
    "size": 1536,
    "distance": "Cosine"
  },
  "payload_schema": {
    "message_id": "uuid",
    "chat_id": "uuid",
    "content": "text",
    "sender_type": "keyword",
    "sender_id": "text",
    "created_at": "integer"
  }
}
```

#### memory_embeddings

```json
{
  "collection_name": "memory_embeddings",
  "vectors": {
    "size": 1536,
    "distance": "Cosine"
  },
  "payload_schema": {
    "memory_id": "uuid",
    "type": "keyword",
    "scope": "keyword",
    "chat_id": "uuid",
    "summary_text": "text",
    "tags": "array",
    "created_at": "integer"
  }
}
```

### 3.2 å‘é‡æ“ä½œ

```python
class VectorStore:
    """
    å‘é‡å­˜å‚¨æŠ½è±¡
    """

    async def search_messages(
        self,
        query_embedding: List[float],
        chat_id: Optional[str] = None,
        limit: int = 10,
        score_threshold: float = 0.7
    ) -> List[SearchResult]:
        """æœç´¢ç›¸ä¼¼æ¶ˆæ¯"""
        pass

    async def search_memories(
        self,
        query_embedding: List[float],
        scope: MemoryScope = MemoryScope.GLOBAL,
        memory_types: Optional[List[MemoryType]] = None,
        limit: int = 10
    ) -> List[SearchResult]:
        """æœç´¢ç›¸ä¼¼è®°å¿†"""
        pass

    async def upsert_message(
        self,
        message_id: str,
        embedding: List[float],
        payload: Dict
    ) -> str:
        """æ’å…¥/æ›´æ–°æ¶ˆæ¯å‘é‡"""
        pass

    async def upsert_memory(
        self,
        memory_id: str,
        embedding: List[float],
        payload: Dict
    ) -> str:
        """æ’å…¥/æ›´æ–°è®°å¿†å‘é‡"""
        pass
```

---

## 4. API è®¾è®¡

### 4.1 API ç‰ˆæœ¬

```
Base URL: https://api.clawteam.com/v1
```

### 4.2 æ ¸å¿ƒ API

#### æ¶ˆæ¯ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| POST | /chats/{chat_id}/messages | å‘é€æ¶ˆæ¯ |
| GET | /chats/{chat_id}/messages | è·å–æ¶ˆæ¯åˆ—è¡¨ |
| PATCH | /messages/{message_id} | ç¼–è¾‘æ¶ˆæ¯ |
| DELETE | /messages/{message_id} | åˆ é™¤æ¶ˆæ¯ |

#### Agent ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| GET | /agents | è·å– Agent åˆ—è¡¨ |
| POST | /agents | åˆ›å»º Agent |
| GET | /agents/{agent_id} | è·å– Agent è¯¦æƒ… |
| PATCH | /agents/{agent_id} | æ›´æ–° Agent |
| DELETE | /agents/{agent_id} | åˆ é™¤ Agent |
| POST | /agents/{agent_id}/invoke | æ‰‹åŠ¨è°ƒç”¨ Agent |

#### è®°å¿†ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| GET | /memory/search | å…¨å±€æœç´¢ |
| POST | /memory/entries | åˆ›å»ºè®°å¿†æ¡ç›® |
| GET | /memory/entries/{id} | è·å–è®°å¿†è¯¦æƒ… |
| PATCH | /memory/entries/{id} | æ›´æ–°è®°å¿† |
| DELETE | /memory/entries/{id} | åˆ é™¤è®°å¿† |
| GET | /memory/tags | è·å–æ ‡ç­¾åˆ—è¡¨ |

#### ä»»åŠ¡ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| GET | /tasks | è·å–ä»»åŠ¡åˆ—è¡¨ |
| POST | /tasks | åˆ›å»ºä»»åŠ¡ |
| GET | /tasks/{id} | è·å–ä»»åŠ¡è¯¦æƒ… |
| PATCH | /tasks/{id} | æ›´æ–°ä»»åŠ¡ |
| DELETE | /tasks/{id} | åˆ é™¤ä»»åŠ¡ |

#### å®¡æ‰¹ç›¸å…³

| æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|------|------|------|
| GET | /approvals | è·å–å¾…å®¡æ‰¹åˆ—è¡¨ |
| POST | /approvals/{id}/approve | æ‰¹å‡† |
| POST | /approvals/{id}/reject | æ‹’ç» |

### 4.3 API è¯·æ±‚ç¤ºä¾‹

#### å‘é€æ¶ˆæ¯

```http
POST /v1/chats/{chat_id}/messages HTTP/1.1
Content-Type: application/json
Authorization: Bearer {token}

{
  "content": "@SummaryAgent å¸®æˆ‘æ€»ç»“ä»Šå¤©çš„è®¨è®º",
  "reply_to": null
}
```

#### æœç´¢è®°å¿†

```http
GET /v1/memory/search?q=roadmap&scope=global&limit=10 HTTP/1.1
Authorization: Bearer {token}
```

#### åˆ›å»º Agent

```http
POST /v1/agents HTTP/1.1
Content-Type: application/json
Authorization: Bearer {token}

{
  "name": "My Agent",
  "template": "custom",
  "system_prompt": "You are a helpful assistant...",
  "model_config": {
    "model": "claude-3-5-sonnet",
    "temperature": 0.7,
    "max_tokens": 2000
  },
  "capabilities": ["qa", "summarize"],
  "scope_type": "selected",
  "scope_chats": ["{chat_id}"],
  "can_write_memory": false,
  "can_create_tasks": true
}
```

---

## 5. æ•°æ®è¿ç§»

### 5.1 è¿ç§»ç­–ç•¥

```mermaid
flowchart LR
    A[å½“å‰] --> B[è®¾è®¡ Schema]
    B --> C[ç”Ÿæˆè¿ç§» SQL]
    C --> D[Review]
    D --> E[æµ‹è¯•ç¯å¢ƒ]
    E --> F[éªŒè¯]
    F --> G[ç”Ÿäº§ç¯å¢ƒ]
    G --> H[å›æ»šè®¡åˆ’]
```

### 5.2 è¿ç§»å·¥å…·

```bash
# ä½¿ç”¨ golang-migrate
migrate create -ext sql -dir migrations -seq create_users_table

# æ‰§è¡Œè¿ç§»
migrate -path migrations -database "postgres://..." up

# å›æ»š
migrate -path migrations -database "postgres://..." down 1
```

### 5.3 æ•°æ®å¤‡ä»½ç­–ç•¥

| ç±»å‹ | é¢‘ç‡ | ä¿ç•™æœŸ |
|------|------|--------|
| **å…¨é‡å¤‡ä»½** | æ¯å¤© | 30 å¤© |
| **å¢é‡å¤‡ä»½** | æ¯å°æ—¶ | 7 å¤© |
| **WAL å½’æ¡£** | å®æ—¶ | 90 å¤© |

---

## ğŸ·ï¸ æ ‡ç­¾

`#æ•°æ®æ¨¡å‹` `#æ•°æ®åº“è®¾è®¡` `#APIè®¾è®¡` `#PostgreSQL` `#Qdrant`
